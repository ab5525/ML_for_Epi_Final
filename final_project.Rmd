---
title: "Final_Project"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(pacman)

pacman::p_load(pacman, Amelia, caret, cluster, devtools, factoextra, gbm, GGally, ggplot2, ggthemes, 
  ggvis, ggbiplot,httr, knitr,lubridate, plotly, pROC,randomForest, rio, rpart, rpart.plot, rmarkdown, shiny, 
  stringr, stats,tidyr, tidyverse) 

set.seed(123)
```


### Load Data

```{r process_data}
df <- import('data/C3longitudinal_clean.csv')
info_cols <- c('STATE','RecSource','DurationV0','age','household_size','air_travel','gender','race')
risk_cols <- c('smokeV0','esmokeV0','antiviral','alcohol_use')
interest_cols <- c('early_vax_interest','delay_side_effects','delay_inconvenient','delay_trust','children_delay_se','children_delay_incon','children_delay_trust')
exposure_cols <- c('swimming_1','park_1','no_exp','swimming_2','park_2','no_exp2','movie_1','mall_1','church_1','movie_2','mall_2','church_2')
outcome_cols <- c('had_covid','booster','vaccinated')
fear_cols <- c()

df[,interest_cols]
```
```{r}
df <- na.omit(df)
library(dplyr)

df <- df %>% mutate(
   combined_1 = as.logical(swimming_1 + park_1 + movie_1 + mall_1 + church_1 + air_travel),
   combined_2 = as.logical(swimming_2 + park_2 + movie_2 + mall_2 + church_2),
   combined_any = as.logical(swimming_1 + park_1 + movie_1 + mall_1 + church_1 
                             + swimming_2 + park_2 + movie_2 + mall_2 + church_2 + air_travel),
)

df
```

```{r propensity scoring}
# logistic regression for if someone ever went to exposure locations based on race, age, gender etc.  
ps.model.logit <- glm(combined_any ~ age + gender + race + household_size ,
                    data=df, family=binomial(link="logit"))
    summary(ps.model.logit)
    
    # estimates odds of eversmoke, then convert to probability (aka the propensity score)
    prop.score <- (predict(ps.model.logit, df, type="response"))
    df$PS.LOGIT <- prop.score
    
    # Logistic Regression model can be misspecified rather easily. Example, do age and smoking have a linear relationship?
    
   #temp<-table(nmesdata$eversmk, df$LASTAGE) 
    #pct.eversmk <- 100*(temp[2, ] / (temp[2,] + temp[1,]))
    #plot(40:94, pct.eversmk, xlab="Age", ylab="% ever smokers", pch=".", cex=7, cex.lab=1.5, cex.axis=1.5)
```


### Unsupervised learning and clustering

```{r unsupervised}
dist.matrix <- dist(df[,interest_cols], method="euclidean")
h <- hclust(dist.matrix, method="complete")
plot(h)

silhouette_score <- function(k){
    cluster <- cutree(tree=h, k=k)
    ss <- silhouette(cluster, dist.matrix)
    mean(ss[, 3])
}

k <- 2:20

avg_sil <- sapply(k, silhouette_score)
sil_df <- data.frame(Clusters=k, Score=avg_sil)
p <- ggplot(sil_df, mapping=aes(x=Clusters, y=Score)) + geom_point(size=3) + labs(x="Number of Clusters", y="Silhouette Score") +
          theme(axis.line = element_line(colour = "black"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_rect(fill = 'white'))

print(p)

### although 2 clusters shows the highest silhouette score, it is not particularly informative (probably tells us only people who are interested vs not interested). 7 clusters seems to show a marked increase in score from 6 clusters, so that may be the best option to show patterns in vaccine interest.

clustering <- cutree(tree=h, k=7)
clustering <- as.factor(clustering)
df$interest_cluster <- clustering

### each cluster has a different approach to interest. For example, cluster 1 are interested in vaccines early, and will not be delayed for any reason. Cluster 2 are interested in vaccines early, but they would delay for side effects and inconveniences for themselves although not for their children. Etc.

df[df$interest_cluster == 2, interest_cols]
```


### logistic regression predictions for fun
```{r logistic regression}
logit <- glm(vaccinated ~ PS.LOGIT + hoax + early_vax_interest + air_travel ,
                    data=df, family=binomial(link="logit"))

summary(logit)


#social
logit <- glm(vaccinated ~ PS.LOGIT + smokeV0 + esmokeV0 + alcohol_use,
                    data=df, family=binomial(link="logit"))

summary(logit)

#social

print('Had covid')
logit <- glm(had_covid ~ PS.LOGIT + vaccinated + booster + early_vax_interest,
                    data=df, family=binomial(link="logit"))

summary(logit)
```

